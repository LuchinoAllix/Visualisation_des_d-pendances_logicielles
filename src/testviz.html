<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Animated Tree Slider with D3.js</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
     .tree-container {
      width: 100%;
    }
    .link {
      fill: none;
      stroke: #555;
      stroke-width: 1.5px;
    }
    .tooltip {
      position: absolute;
      text-align: center;
      width: auto;
      height: auto;
      padding: 5px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    #filename {
      text-align: left;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="filename"></div>
	<div class="tree-container"></div>
	<input type="range" min="1" max="95" value="1" id="tree-slider">
	<div class="tooltip" style="opacity:0;"></div>

  <script>

	let treesData = [];
  let currentTreeIndex = 0;	

	const width = document.querySelector('.tree-container').clientWidth;
  const height = 500;
  const tooltip = d3.select(".tooltip");

	function drawTree(treeData){

		// set the dimensions and margins of the diagram
		const margin = {top: 20, right: 90, bottom: 30, left: 90},
		      width = 1200 - margin.left - margin.right,
		      height = 650 - margin.top - margin.bottom;

		// declares a tree layout and assigns the size
		const treemap = d3.tree().size([width,height]);

		//  assigns the data to a hierarchy using parent-child relationships
		let nodes = d3.hierarchy(treeData, d => d.children);

		// maps the node data to the tree layout
		nodes = treemap(nodes);

		// append the svg object to the body of the page
		// appends a 'group' element to 'svg'
		// moves the 'group' element to the top left margin
		const svg = d3.select("body")
                  .append("svg")
				          .attr("width", width + margin.left + margin.right)
				          .attr("height", height + margin.top + margin.bottom),
			    g = svg.append("g")
				          .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

    const link = g.selectAll(".link")
                  .data(nodes.descendants().slice(1))
                  .enter().append("line")
                  .attr("class", "link")
                  .style("stroke", d => d.data.level)
                  .attr("x1", d => d.x)
                  .attr("y1", d => d.y)
                  .attr("x2", d => d.parent.x)
                  .attr("y2", d => d.parent.y);

		// adds each node as a group
		const node = g.selectAll(".node")
			            .data(nodes.descendants())
			            .enter().append("g")
			            .attr("class", 
                    d => "node" + (d.children ? " node--internal" : 
                                                " node--leaf"))
			            .attr("transform", 
                    d => "translate(" + d.x + "," + d.y + ")");

		// adds the circle to the node
		node.append("circle")
        .attr("r", 0.1)
        .style("stroke", d => d.data.type)
        .style("fill", d => d.data.level)
        .on("mouseover", (d) => {
          tooltip.transition().duration(200).style("opacity", .9);
          tooltip.html("Name: " + d.data.name + "<br/>");
        })
        .on("mouseout", d => {
          tooltip.transition().duration(500).style("opacity", 0);
        });

		// adds the text to the node
		/*
		node.append("text")
		.attr("dy", ".35em")
		.attr("x", d => d.children ? (d.data.value + 5) * -1 : d.data.value + 5)
		.attr("y", d => d.children && d.depth !== 0 ? -(d.data.value + 5) : d)
		.style("text-anchor", d => d.children ? "end" : "start")
		.text(d => d.data.name);*/

	}

  fetch('http://localhost:3000/api/tree-files') // Assurez-vous que l'URL correspond Ã  votre serveur Node.js
    .then(response => response.json())
    .then(files => {
      const treeFiles = files.map(file => `http://127.0.0.1:3000/api/trees/${file}`); // Chemins vers les fichiers JSON
      return Promise.all(treeFiles.map(file => fetch(file).then(response => response.json())));
    })
    .then(data => {
      console.log('Data loaded:', data);
      treesData = data
      drawTree()
    })
    .catch(error => console.error('Error fetching or processing tree files:', error));

  // Slider functionality
  const slider = document.getElementById("tree-slider");
  slider.addEventListener("input", () => {
    const index = parseInt(slider.value) - 1;
    if (index !== currentTreeIndex) {
      currentTreeIndex = index;
      d3.select("svg").remove(); // Remove existing SVG
      drawTree(treesData[currentTreeIndex]);
      document.getElementById('filename').textContent = `Tree number : ${currentTreeIndex}`;
      //document.getElementById('filename').textContent = `Tree number : ${treesData[currentTreeIndex].name}`;
    }
  });
  
  </script>
</body>
</html>
